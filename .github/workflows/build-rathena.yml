name: Build & Deploy rAthena Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deploy:
    name: Build & Deploy to DigitalOcean
    runs-on: ubuntu-latest
    environment: production

    steps:
      # =========================
      # 1️⃣ Checa o repositório
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # 2️⃣ Instala dependências
      # =========================
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake mysql-client libmysqlclient-dev zlib1g-dev libssl-dev

      # =========================
      # 3️⃣ Compila o rAthena com Web Server
      # =========================
      - name: Build rAthena (CMake)
        run: |
          cmake -B build -DWEB_SERVER_ENABLE=ON
          cmake --build build --parallel
          ls -la build/

      # =========================
      # 4️⃣ Empacota os binários
      # =========================
      - name: Package build artifacts
        run: |
          tar -czvf rathena-binaries.tar.gz -C build .

      # =========================
      # 5️⃣ Faz upload para o servidor (Droplet)
      # =========================
      - name: Upload binaries to DigitalOcean
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: rathena-binaries.tar.gz
          target: /root/endless/rathena/

      # =========================
      # 6️⃣ Reinicia o servidor remotamente
      # =========================
      - name: Restart rAthena server remotely
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            cd /root/endless/rathena
            tar -xzvf rathena-binaries.tar.gz
            rm rathena-binaries.tar.gz
            ./athena-start restart
            echo "✅ rAthena successfully redeployed!"
