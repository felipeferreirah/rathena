name: rAthena CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_DIR: build
  ARTIFACT_NAME: rathena-binaries.tar.gz

# ==========================================
# 1️⃣ PREPARE ENVIRONMENT
# ==========================================
jobs:
  prepare:
    name: 🧰 Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: 🧭 Update server repository (auto-detect branch)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          timeout: 90s
          command_timeout: 90s
          script: |
            cd /root/endless/rathena || exit 1
            BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "master")
            echo "🧭 Detected branch: $BRANCH"
            git fetch origin $BRANCH
            git reset --hard origin/$BRANCH
            git clean -fdx

      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake mysql-client libmysqlclient-dev zlib1g-dev libssl-dev

      - name: 🗃️ Cache dependencies (CMake)
        id: cache
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: cmake-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}

# ==========================================
# 2️⃣ BUILD SERVER
# ==========================================
  build:
    name: 🏗️ Build rAthena (CMake)
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🧱 Configure and Build
        run: |
          mkdir -p $BUILD_DIR
          cmake -B $BUILD_DIR -DWEB_SERVER_ENABLE=ON
          cmake --build $BUILD_DIR --parallel $(nproc)
          echo "✅ Build complete"

      - name: ✅ Verify build results
        run: |
          ls -lh $BUILD_DIR/
          for bin in login-server char-server map-server web-server; do
            if [ -f "$BUILD_DIR/$bin" ]; then
              echo "✅ $bin OK"
            else
              echo "⚠️ $bin missing"
            fi
          done

      - name: 📦 Package binaries + scripts
        run: |
          echo "📦 Creating package..."
          tar -czvf $ARTIFACT_NAME \
            -C $BUILD_DIR . \
            -C $GITHUB_WORKSPACE start-server.sh redeploy.sh
          ls -lh $ARTIFACT_NAME

      - name: ⬆️ Upload compiled binaries
        uses: actions/upload-artifact@v4
        with:
          name: rathena-binaries
          path: ${{ env.ARTIFACT_NAME }}

# ==========================================
# 3️⃣ DEPLOY TO DIGITAL OCEAN
# ==========================================
  deploy:
    name: 🚀 Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: 📥 Download artifact from build
        uses: actions/download-artifact@v4
        with:
          name: rathena-binaries
          path: .

      - name: 🌍 Upload binaries via SSH (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: rathena-binaries.tar.gz
          target: /root/endless/rathena/

      - name: 🔄 Run remote redeploy script
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          timeout: 180s
          command_timeout: 120s
          script_stop: false
          debug: true
          script: |
            echo "🚀 Executando redeploy remoto..."
            cd /root/endless/rathena || exit 1
            if [ -f ./redeploy.sh ]; then
              bash ./redeploy.sh
            else
              echo "⚠️ redeploy.sh não encontrado!"
            fi
            echo "✅ Redeploy concluído remotamente!"
