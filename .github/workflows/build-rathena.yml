name: rAthena CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: build
  ARTIFACT_NAME: rathena-binaries.tar.gz

# ==========================================
# 1ï¸âƒ£ PREPARE ENVIRONMENT
# ==========================================
jobs:
  prepare:
    name: ğŸ§° Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake mysql-client libmysqlclient-dev zlib1g-dev libssl-dev

      - name: ğŸ—ƒï¸ Cache dependencies (CMake)
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache
          key: cmake-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}

      - name: ğŸ§¹ Clean unnecessary triggers
        run: |
          git diff --name-only HEAD~1 HEAD | grep -q 'conf/' && echo "âš ï¸ Conf change detected â€” skipping rebuild" && exit 0 || echo "No conf changes, building..."


# ==========================================
# 2ï¸âƒ£ BUILD SERVER
# ==========================================
  build:
    name: ğŸ—ï¸ Build rAthena (CMake)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§± Configure and Build
        run: |
          cmake -B $BUILD_DIR -DWEB_SERVER_ENABLE=ON
          cmake --build $BUILD_DIR --parallel
          ls -la $BUILD_DIR/

      - name: âœ… Verify build result
        run: |
          test -f $BUILD_DIR/map-server && echo "âœ… map-server OK" || exit 1
          test -f $BUILD_DIR/char-server && echo "âœ… char-server OK" || exit 1
          test -f $BUILD_DIR/login-server && echo "âœ… login-server OK" || exit 1
          test -f $BUILD_DIR/web-server && echo "âœ… web-server OK" || echo "âš ï¸ Web server missing"

# ==========================================
# 3ï¸âƒ£ PACKAGE & UPLOAD
# ==========================================
  package:
    name: ğŸ“¦ Package & Upload Artifacts
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“ Download previous build output (if cached)
        uses: actions/download-artifact@v4
        if: always()
        with:
          name: rathena-binaries
          path: .

      - name: ğŸ“¦ Create tarball
        run: |
          tar -czvf $ARTIFACT_NAME -C build .
          ls -lh $ARTIFACT_NAME

      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathena-binaries
          path: ${{ env.ARTIFACT_NAME }}

# ==========================================
# 4ï¸âƒ£ DEPLOY TO DIGITAL OCEAN
# ==========================================
  deploy:
    name: ğŸš€ Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: package
    environment: production

    steps:
      - name: ğŸ“¥ Download artifact from build
        uses: actions/download-artifact@v4
        with:
          name: rathena-binaries
          path: .

      - name: ğŸŒ Upload binaries via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: rathena-binaries.tar.gz
          target: /root/endless/rathena/

      - name: ğŸ”„ Restart rAthena services remotely
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            cd /root/endless/rathena
            tar -xzvf rathena-binaries.tar.gz
            rm rathena-binaries.tar.gz
            ./athena-start restart || ./athena-start start
            echo "âœ… rAthena fully redeployed!"
